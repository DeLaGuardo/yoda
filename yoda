#!/usr/bin/env bash
set -e
YODA_CMD='yoda'
YODA_VERSION='0.2-dev'
YODA_BIN=$(test -h $0 && readlink $0 || echo $0)
YODA_PATH=${YODA_BIN%/*}

if [[ -z "$1" ]]; then
  echo "No command specified. Run '$YODA_CMD command'. '$YODA_CMD help' for more info." && exit 1
fi
cmd=$1
shift

# Auto version switch and update
source_yoda_version=$YODA_VERSION

yodarc_file=$(ls */.yodarc 2>/dev/null || true)
if [[ -n "$yodarc_file" ]]; then
  # shellcheck source=yoda/.yodarc
  source $yodarc_file
fi

if [[ "$source_yoda_version" != "$YODA_VERSION" ]]; then
  (
    set +e
    echo "Current Yoda version: '$source_yoda_version'."
    echo "Switching to project Yoda version: '$YODA_VERSION'."
    cd $YODA_PATH
    git fetch
    git pull --rebase origin master
    git checkout $YODA_VERSION
    switched_version=$(cat $YODA_BIN | grep "YODA_VERSION=$YODA_VERSION")
    if [[ "$switched_version" == "$YODA_VERSION" ]]; then
      exec $YODA_BIN $cmd "$*"
    else
      echo "Failed to switch version to '$YODA_VERSION'. Using '$source_yoda_version'."
    fi
  )2> /dev/null
fi

# shellcheck source=docker/env.sh
test -e $DOCKER_ROOT/env.sh && source $_

for p in "$@"; do
  case $p in
    *)
      ;;
  esac
done

# Use custom start layout if there is start file
custom_run() {
  script=$1
  shift
  echo "Custom run: $DOCKER_ROOT/$script"
  if [[ -e $DOCKER_ROOT/$script && ! -x $DOCKER_ROOT/$script ]]; then
    echo "$DOCKER_ROOT/$script is found but its not executable. Run 'chmod +x $DOCKER_ROOT/$script' to make it work."
    return 1
  fi

  if [[ -x $DOCKER_ROOT/$script ]]; then
    exec $DOCKER_ROOT/$script "$*"
    exit 0
  fi
}

allow_dev_only() {
  if [[ $ENV != 'dev' ]]; then
    echo "Your environment: $ENV. This command is allowed only in 'dev' environment."
    return 1
  fi
}

case "$cmd" in
  init)
    arg_dir="$*"
    yoda_dir=${arg_dir:-yoda}
    if [[ -e $yoda_dir ]]; then
      echo "Error while initializing Yoda. Folder '$yoda_dir' already exists."
      if [[ -f $DOCKER_ROOT/.yodarc ]]; then
        # shellcheck source=yoda/.yodarc
        source $DOCKER_ROOT/.yodarc
        echo "Initialized Yoda version: '$YODA_VERSION'. Yoda home path: '$DOCKER_ROOT'."
      fi
      exit 1
    fi

    project_name=${arg_name:-"${PWD##*/}"}
    username=$(git config --global user.name || echo 'Unknown maintainer')
    useremail=$(git config --global user.email || echo 'noreply@yoda.org')

    touch .dockerignore
    mkdir -p $yoda_dir/{images,containers}
    cp $YODA_PATH/templates/env.sh $yoda_dir
    cp $YODA_PATH/templates/Envfile $yoda_dir
    cp $YODA_PATH/templates/Buildfile $yoda_dir/images
    sed "s/%user%/$username/g;s/%email%/$useremail/g;" $YODA_PATH/templates/Dockerfile > $yoda_dir/images/Dockerfile-base
    cp $YODA_PATH/templates/gitignore $yoda_dir/.gitignore
    cp $YODA_PATH/templates/dockerignore $yoda_dir/.dockerignore
    sed "s/%name%/$project_name/g;s/%yoda_version%/$YODA_VERSION/g" $YODA_PATH/templates/yodarc > $yoda_dir/.yodarc
    ;;

  add|delete)
    allow_dev_only
    arg_name="$*"
    if [[ -z "$arg_name" ]]; then
      echo "Did you mean '$YODA_CMD container'? '$YODA_CMD help' for more info." && exit 1
    fi

    for name in $arg_name; do
      container_path="$DOCKER_ROOT/containers/$name"
      if [[ $cmd == add ]]; then
        if [[ -d $container_path ]]; then
          echo "Container exists: '$name'. Skipping: '$container_path'."
          continue
        fi
        mkdir -p $container_path
        sed "s/%name%/$name/g" $YODA_PATH/templates/container.yml > $container_path/container.yml
        cp $YODA_PATH/templates/entrypoint $container_path
        sed "s/^dev\:\(.*\)/dev\:\1 $name/" $DOCKER_ROOT/Envfile > $DOCKER_ROOT/.Envfile.swp && mv $DOCKER_ROOT/.Envfile.swp $_
      else
        test -d $container_path && rm -fr $_
        sed "s/ $name/ /" $DOCKER_ROOT/Envfile > $DOCKER_ROOT/.Envfile.swp && mv $DOCKER_ROOT/.Envfile.swp $_
      fi
    done
    ;;

  compose)
    arg_composer="$*"
    custom_run compose
    # Get containers to build
    containers=$(cat $DOCKER_ROOT/Envfile | grep ^$ENV: | cut -d ':' -f2)
    COMPOSE_SCRIPT=$arg_composer bash "$YODA_PATH/compose.sh" $containers
    ;;

  build)
    lock_file="$DOCKER_ROOT/.build.lock"
    lock() {
      touch $lock_file
    }

    unlock() {
      test -f $lock_file && rm -f $_
    }

    if [[ -f $lock_file ]]; then
      echo "Build is already in progress."
      echo "If something went wrong you should just remove lock file: $lock_file"
      exit 1
    fi

    trap unlock EXIT
    lock

    custom_run build
    bash "$YODA_PATH/build.sh"
    ;;

  start)
    custom_run start "$*"
    $0 compose > $COMPOSE_FILE
    $0 build
    docker-compose up --no-build --remove-orphans -t $STOP_WAIT_TIMEOUT -d "$*"
    ;;

  stop)
    custom_run stop "$*"
    docker-compose stop -t $STOP_WAIT_TIMEOUT "$*"
    ;;

  deploy)
    if [[ -z "$GIT_URL" ]]; then
      echo "GIT_URL is empty. Are you sure you are in git repository?"
      exit 1
    fi

    custom_run deploy "$*"
    bash "$YODA_PATH/deploy.sh" "$*"
    ;;

  help)
    YODA_CMD=$YODA_CMD bash "$YODA_PATH/help.sh"
    ;;

  version)
    echo "Yoda version: $YODA_VERSION"
    ;;

  *)
    echo "Unknown command '$cmd'"
    echo "Run '$YODA_CMD help' to see more info"
    ;;
esac
